name: Django-app workflow

on: [push]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 
      uses: actions/setup-python@v2
      with:
        python-version: 3.7

    - name: Install dependencies
      run: | 
        python -m pip install --upgrade pip 
        pip install flake8 pep8-naming flake8-broken-line flake8-return flake8-isort
        pip install -r requirements.txt 

    - name: Test with flake8 and django tests
      run: |
        python -m flake8
        cd infra_project/
        python manage.py test

  build_and_push_to_docker_hub:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Check out the repo
        # Проверка доступности репозитория Docker Hub для workflow
        uses: actions/checkout@v2 
      - name: Set up Docker Buildx
        # Вызов сборщика контейнеров docker
        uses: docker/setup-buildx-action@v1 
      - name: Login to Docker 
        # Запуск скрипта авторизации на Docker Hub
        uses: docker/login-action@v1 
        with:
          username: ${{ secrets.DOCKER_USERNAME }} 
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Push to Docker Hub
        # Пуш образа в Docker Hub 
        uses: docker/build-push-action@v2 
        with:
          push: true
          tags: cocosi383/infra_actions

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push_to_docker_hub
    steps:
    - name: executing remote ssh commands to deploy
      uses: appleboy/ssh-action@master
      with:
        host: 51.250.100.101
        username: cocosi
        key: -----BEGIN OPENSSH PRIVATE KEY-----
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
nJ9Qtih1n8KuiEV3McWZ3tAf+u0=
-----END OPENSSH PRIVATE KEY-----
        script: |
          # Выполняет pull образа с DockerHub
          sudo docker pull cocosi383/infra_actions
          #остановка всех контейнеров
          sudo docker stop ps -a -q | xargs sudo docker stop
          sudo docker run --rm -d -p 5000:5000 cocosi383/infra_actions